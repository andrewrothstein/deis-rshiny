# Find number of cores (Linux only)
options(Ncpus = as.integer(system2("nproc", stdout = TRUE)))

# Exclude some super-slow packages
ignore <- c(
  "PopGenReport", "mizer", "EpiModel", "caret", "phylosim", "icd9", "NMF",
  "ndtv", "msm",
  "BEQI2", # not necessarily slow by itself, but it may want some X11 interaction
  "Rglpk"  # Can't compile this one - needs GLPK library?
)

# Wrapper for revdep_check. Reports time and sends a pushbullet message.
rdc <- function(pkg, ...) {
  start_time <- Sys.time()
  res <- devtools::revdep_check(pkg, libpath = .libPaths()[1], ignore = ignore,
																threads = getOption('Ncpus'), ...)
  end_time <- Sys.time()

  cat(paste("revdep_check for", pkg, "finished in",
    round(difftime(end_time, start_time, units = "secs")), "seconds.\n"))

  res
}

# Get env vars by running this
showvars <- function(res) {
  pkg <- res$revdep_package
  desc <- packageDescription(pkg)
  rstatus <- if (grepl("devel", R.version$status)) "r-devel" else "r-release"

  pkgversion <- desc$Version
  if (!is.null(desc$GithubSHA1))
    pkgversion <- paste0(pkgversion, " (", substr(desc$GithubSHA1, 1, 7), ")")

  sprintf('
    RVERSION=%s.%s
    RSTATUS=%s
    RPKG=%s
    RPKGVERSION="%s"
    CHECKDIR="%s"\n',
    R.version$major, R.version$minor,
    rstatus,
    pkg,
    pkgversion,
    file.path(res$path, "results")
  )
}
